<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora SMA - Movimento Mais Brasil</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .header h1 { color: #667eea; margin-bottom: 10px; }
        .header p { color: #666; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #764ba2;
        }
        .form-section { margin-bottom: 25px; }
        .form-section h3 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        input[type="number"],
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            background: #764ba2;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background 0.3s;
        }
        .btn:hover { background: #667eea; }
        .btn-action {
            background: white;
            color: #764ba2;
            padding: 10px 20px;
            border: 2px solid #764ba2;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-action:hover {
            background: #764ba2;
            color: white;
        }
        .resultado { display: none; }
        .resultado.show { display: block; }
        .valor-destaque {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .valor-destaque h3 { color: #667eea; margin-bottom: 10px; }
        .valor-destaque .valor {
            font-size: 32px;
            font-weight: bold;
            color: #764ba2;
        }
        .opcoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .opcao-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .opcao-card.destaque {
            border-color: #764ba2;
            background: #f3e5f5;
        }
        .opcao-card h4 { color: #667eea; margin-bottom: 10px; }
        .opcao-valor {
            font-size: 24px;
            font-weight: bold;
            color: #764ba2;
            margin: 10px 0;
        }
        .opcao-info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .vantagens, .desvantagens { margin-top: 15px; }
        .vantagens h5 { color: #4caf50; margin-bottom: 5px; }
        .desvantagens h5 { color: #f44336; margin-bottom: 5px; }
        .vantagens ul, .desvantagens ul {
            list-style: none;
            padding-left: 0;
        }
        .vantagens li::before {
            content: "‚úì ";
            color: #4caf50;
            font-weight: bold;
        }
        .desvantagens li::before {
            content: "‚úó ";
            color: #f44336;
            font-weight: bold;
        }
        .tabela-parcelas {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .tabela-parcelas th, .tabela-parcelas td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .tabela-parcelas th {
            background: #f5f5f5;
            font-weight: 600;
            color: #667eea;
        }
        .info-box {
            background: #e8eaf6;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #764ba2;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 1200px) {
            .main-content { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .opcoes-grid { grid-template-columns: 1fr; }
        }
        @media print {
            .header, .card:first-child, .btn, .btn-action { display: none !important; }
            body { background: white; padding: 0; }
            .main-content { grid-template-columns: 1fr; }
            .card { box-shadow: none; page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Calculadora SMA - Socorro M√∫tuo Acordo</h1>
            <p>Movimento Mais Brasil - Antecipa√ß√£o de Valores de Reparo</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>üìã Dados do Sinistro</h2>
                <form id="formCalculadora">
                    <div class="form-section">
                        <h3>üë§ Dados do Benefici√°rio</h3>
                        <div class="form-group">
                            <label>Nome do Benefici√°rio: *</label>
                            <input type="text" id="nome_beneficiario" required>
                        </div>
                        <div class="form-group">
                            <label>Placa do Ve√≠culo: *</label>
                            <input type="text" id="placa_veiculo" required maxlength="7" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Ve√≠culo (Marca/Modelo): *</label>
                            <input type="text" id="veiculo" required placeholder="Ex: CHEVROLET ONIX">
                        </div>
                        <div class="form-group">
                            <label>Data da Abertura do Sinistro: *</label>
                            <input type="date" id="data_sinistro" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Valores do Sinistro</h3>
                        <div class="form-group">
                            <label>Valor da Regulagem (R$): *</label>
                            <input type="number" id="valor_regulagem" step="0.01" required>
                            <small style="color: #666;">Valor aprovado pelo regulador/perito</small>
                        </div>
                        <div class="form-group">
                            <label>Valor da Participa√ß√£o/Franquia (R$): *</label>
                            <input type="number" id="valor_participacao" step="0.01" value="0" required>
                            <small style="color: #666;">Cota de participa√ß√£o do associado</small>
                        </div>
                        <div class="form-group">
                            <label>Or√ßamento da Oficina/CILIA (R$):</label>
                            <input type="number" id="orcamento_oficina" step="0.01">
                            <small style="color: #666;">Se n√£o tiver, deixe em branco</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Prazos</h3>
                        <div class="form-group">
                            <label>Dias Previstos para Repara√ß√£o:</label>
                            <input type="number" id="dias_reparo" value="15" min="1">
                        </div>
                        <div class="form-group">
                            <label>Dias de Carro Reserva:</label>
                            <input type="number" id="dias_carro_reserva" value="0" min="0" placeholder="Ex: 7, 10, 15...">
                            <small style="color: #666; font-size: 12px;">Custo: R$ 75,00 por di√°ria</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Contraproposta (Opcional)</h3>
                        <div class="form-group">
                            <label>Valor da Contraproposta (R$):</label>
                            <input type="number" id="contraproposta" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Configura√ß√µes do Financiamento</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Taxa de Juros Mensal (%):</label>
                                <input type="number" id="taxa_juros" step="0.01" min="3.95" max="5" value="3.95" required>
                                <small style="color: #666;">Entre 3,95% e 5%</small>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Parcelas:</label>
                                <input type="number" id="n_parcelas" value="4" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                                <small style="color: #666;">Fixo em 4 parcelas</small>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn">üßÆ Calcular Valores do Acordo</button>
                </form>
            </div>

            <div class="card resultado" id="resultado">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üí∞ Resultado do C√°lculo</h2>
                    <div>
                        <button onclick="imprimirResultado()" class="btn-action" style="margin-right: 10px;">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button onclick="gerarPDF()" class="btn-action">
                            üìÑ Gerar PDF
                        </button>
                    </div>
                </div>
                
                <div id="observacoes"></div>

                <div id="dadosBeneficiario" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #764ba2; padding-bottom: 8px;">üë§ Dados do Benefici√°rio</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Nome:</strong>
                            <div id="dadoNome" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Placa:</strong>
                            <div id="dadoPlaca" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Ve√≠culo:</strong>
                            <div id="dadoVeiculo" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Data do Sinistro:</strong>
                            <div id="dadoDataSinistro" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                    </div>
                </div>

                <div class="valor-destaque">
                    <h3>Valor Base para C√°lculo</h3>
                    <div class="valor" id="valorLiquido">R$ 0,00</div>
                </div>

                <h3>‚ö° Op√ß√µes de Pagamento</h3>
                <div class="opcoes-grid" id="opcoesGrid"></div>

                <div id="recomendacao"></div>

                <h3>üí≥ Uso da Associa√ß√£o (Detalhamento do Financiamento - Acordo)</h3>
                <div class="info-box">
                    <strong>Valor da Opera√ß√£o:</strong> <span id="valorOperacao"></span><br>
                    <strong>Taxa de Juros:</strong> <span id="taxaJuros"></span><br>
                    <strong>Total a Pagar:</strong> <span id="totalPagar"></span><br>
                    <strong>Custo Financeiro:</strong> <span id="custoFinanceiro"></span>
                </div>

                <h4>Parcelas:</h4>
                <table class="tabela-parcelas" id="tabelaParcelas">
                    <thead>
                        <tr>
                            <th>Parcela</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('formCalculadora');
        const resultado = document.getElementById('resultado');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const dados = {
                valor_regulagem: parseFloat(document.getElementById('valor_regulagem').value),
                valor_participacao: parseFloat(document.getElementById('valor_participacao').value),
                orcamento_oficina: parseFloat(document.getElementById('orcamento_oficina').value) || parseFloat(document.getElementById('valor_regulagem').value),
                dias_reparo: parseInt(document.getElementById('dias_reparo').value),
                dias_carro_reserva: parseInt(document.getElementById('dias_carro_reserva').value) || 0,
                contraproposta: parseFloat(document.getElementById('contraproposta').value),
                taxa_juros: parseFloat(document.getElementById('taxa_juros').value) / 100,
                n_parcelas: parseInt(document.getElementById('n_parcelas').value)
            };

            try {
                const result = calcularSMA(dados);
                exibirResultado(result);
            } catch (error) {
                alert('Erro ao calcular: ' + error.message);
            }
        });

        function calcularSMA(dados) {
            // C√°lculos da Calculadora SMA - F√≥rmulas baseadas na planilha original
            const valor_regulagem = dados.valor_regulagem;
            const valor_participacao = dados.valor_participacao;
            const orcamento_oficina = dados.orcamento_oficina;
            const dias_reparo = dados.dias_reparo;
            const dias_carro_reserva = dados.dias_carro_reserva || 0;
            const contraproposta = dados.contraproposta || 0;
            const taxa_juros = dados.taxa_juros;
            const n_parcelas = dados.n_parcelas;
            
            // C√°lculo do Carro Reserva
            const custo_diaria_carro = 75.00;
            const custo_carro_reserva = dias_carro_reserva * custo_diaria_carro;

            // C√°lculos intermedi√°rios baseados na planilha original
            // H48 = C4 (Regulagem), H49 = C6 (Or√ßamento)
            const h48 = valor_regulagem;
            const h49 = orcamento_oficina;
            const median_valor = (h48 + h49) / 2; // MEDIAN de 2 valores

            // Valores l√≠quidos
            // C21 = (MEDIAN(H48:H49) - C5) * 0.8
            // H21 = (MEDIAN(H48:H49) - C5) * 0.75
            const c21_valor_liquido_80 = (median_valor - valor_participacao) * 0.8;
            const h21_valor_liquido_75 = (median_valor - valor_participacao) * 0.75;

            // Taxas/Custos (C35 e H35)
            // Baseado na an√°lise da planilha: aproximadamente 13.5% do valor l√≠quido
            const taxa_c35 = c21_valor_liquido_80 * 0.1353;
            const taxa_h35 = h21_valor_liquido_75 * 0.1465;

            // Valores finais
            // C15 = C21 - C35 (Valor para Acordo com Associado)
            // H16 = H21 - H35 (Valor para Autoriza√ß√£o na Oficina)
            const valor_acordo_associado = c21_valor_liquido_80 - taxa_c35;
            const valor_autorizacao_oficina = h21_valor_liquido_75 - taxa_h35;

            // Op√ß√£o 1: Reparo em Oficina (Aguardar)
            const opcao1_valor_autorizado = orcamento_oficina;
            const opcao1_prazo = `${dias_reparo} dias √∫teis`;

            // Op√ß√£o 2: Acordo em Dinheiro
            const opcao2_valor_base = valor_acordo_associado;
            const opcao2_valor_recebido = contraproposta > 0 ? contraproposta : opcao2_valor_base;
            const opcao2_prazo = "7 a 10 dias ap√≥s acordo assinado";

            // Op√ß√£o 3: Oficina Antecipada
            const opcao3_valor_autorizado = valor_autorizacao_oficina;
            const opcao3_prazo = "At√© 10 dias ap√≥s finaliza√ß√£o do servi√ßo";

            // Financiamento
            const valor_operacao = opcao2_valor_recebido;
            const taxa_mensal_pct = taxa_juros * 100;
            const valor_parcela = valor_operacao * (taxa_juros * Math.pow(1 + taxa_juros, n_parcelas)) / (Math.pow(1 + taxa_juros, n_parcelas) - 1);
            const total_geral = valor_parcela * n_parcelas;
            const custo_financeiro = total_geral - valor_operacao;
            const percentual_custo = (custo_financeiro / valor_operacao) * 100;

            // Gerar parcelas
            const parcelas = [];
            const hoje = new Date();
            for (let i = 1; i <= n_parcelas; i++) {
                const vencimento = new Date(hoje);
                vencimento.setMonth(vencimento.getMonth() + i);
                parcelas.push({
                    numero: i,
                    vencimento: vencimento.toLocaleDateString('pt-BR'),
                    valor: valor_parcela
                });
            }

            return {
                observacoes: [
                    "C√°lculo baseado nos valores informados",
                    "Taxas e prazos podem variar conforme regulamento"
                ],
                calculos: {
                    valor_liquido: h21_valor_liquido_75  // Valor L√≠quido da REGULAGEM (H21)
                },
                comparacao: {
                    opcao_1_aguardar_reparo: {
                        prazo: opcao1_prazo,
                        custo: valor_regulagem - valor_participacao,
                        custo_carro_reserva: custo_carro_reserva,
                        custo_total: (valor_regulagem - valor_participacao) + custo_carro_reserva,
                        vantagens: ["Ve√≠culo reparado", "Sem desembolso imediato"],
                        desvantagens: ["Aguardar reparo", "Sem dinheiro em m√£os"]
                    },
                    opcao_2_acordo_dinheiro: {
                        valor_recebido: opcao2_valor_recebido,
                        prazo: opcao2_prazo,
                        vantagens: ["Dinheiro imediato", "Liberdade de escolha"],
                        desvantagens: ["Valor pode ser menor", "Responsabilidade pelo reparo"]
                    },
                    opcao_3_oficina_antecipada: {
                        valor_autorizado: opcao3_valor_autorizado,
                        custo_carro_reserva: custo_carro_reserva,
                        valor_total: opcao3_valor_autorizado + custo_carro_reserva,
                        prazo: opcao3_prazo
                    },
                    recomendacao: (() => {
                        const opcao1_total = (valor_regulagem - valor_participacao) + custo_carro_reserva;
                        const opcao2_total = opcao2_valor_recebido; // N√£o inclui carro reserva (dinheiro imediato)
                        const opcao3_total = opcao3_valor_autorizado + custo_carro_reserva;
                        
                        const opcoes = [
                            { nome: "Op√ß√£o 1 (Aguardar Reparo)", valor: opcao1_total },
                            { nome: "Op√ß√£o 2 (Acordo em Dinheiro)", valor: opcao2_total },
                            { nome: "Op√ß√£o 3 (Oficina Antecipada)", valor: opcao3_total }
                        ];
                        const menorOpcao = opcoes.reduce((min, opcao) => opcao.valor < min.valor ? opcao : min);
                        return menorOpcao.nome + " √© mais vantajosa (menor valor)";
                    })()
                },
                acordo_associado: {
                    financiamento: {
                        valor_operacao: valor_operacao,
                        taxa_mensal_pct: taxa_mensal_pct,
                        total_geral: total_geral,
                        custo_financeiro: custo_financeiro,
                        percentual_custo: percentual_custo,
                        parcelas: parcelas
                    }
                }
            };
        }

        function exibirResultado(result) {
            resultado.classList.add('show');
            resultado.scrollIntoView({ behavior: 'smooth' });

            // Preencher dados do benefici√°rio
            document.getElementById('dadoNome').textContent = document.getElementById('nome_beneficiario').value;
            document.getElementById('dadoPlaca').textContent = document.getElementById('placa_veiculo').value.toUpperCase();
            document.getElementById('dadoVeiculo').textContent = document.getElementById('veiculo').value;
            const dataSinistro = document.getElementById('data_sinistro').value;
            if (dataSinistro) {
                const [ano, mes, dia] = dataSinistro.split('-');
                document.getElementById('dadoDataSinistro').textContent = `${dia}/${mes}/${ano}`;
            }

            const observacoes = document.getElementById('observacoes');
            observacoes.innerHTML = '';
            result.observacoes.forEach(obs => {
                observacoes.innerHTML += `<div class="alert alert-info">${obs}</div>`;
            });

            document.getElementById('valorLiquido').textContent = 
                'R$ ' + result.calculos.valor_liquido.toLocaleString('pt-BR', {minimumFractionDigits: 2});

            const opcoesGrid = document.getElementById('opcoesGrid');
            opcoesGrid.innerHTML = '';

            const opcao1 = result.comparacao.opcao_1_aguardar_reparo;
            opcoesGrid.innerHTML += `
                <div class="opcao-card">
                    <h4>üìÖ Op√ß√£o 1: Aguardar Reparo</h4>
                    <div class="opcao-valor">Ve√≠culo Reparado</div>
                    <div class="opcao-info">Prazo: ${opcao1.prazo}</div>
                    <div class="opcao-info">Custo do Sinistro: R$ ${opcao1.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    ${opcao1.custo_carro_reserva > 0 ? `<div class="opcao-info">Carro Reserva: R$ ${opcao1.custo_carro_reserva.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>` : ''}
                    <div class="opcao-info" style="font-weight: bold; font-size: 1.1em; color: #764ba2; margin-top: 8px;">TOTAL: R$ ${opcao1.custo_total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="vantagens">
                        <h5>Vantagens:</h5>
                        <ul>${opcao1.vantagens.map(v => `<li>${v}</li>`).join('')}</ul>
                    </div>
                    <div class="desvantagens">
                        <h5>Desvantagens:</h5>
                        <ul>${opcao1.desvantagens.map(d => `<li>${d}</li>`).join('')}</ul>
                    </div>
                </div>
            `;

            const opcao2 = result.comparacao.opcao_2_acordo_dinheiro;
            opcoesGrid.innerHTML += `
                <div class="opcao-card destaque">
                    <h4>üí∏ Op√ß√£o 2: Acordo em Dinheiro</h4>
                    <div class="opcao-valor">R$ ${opcao2.valor_recebido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    <div class="opcao-info">Prazo: ${opcao2.prazo}</div>
                    <div class="vantagens">
                        <h5>Vantagens:</h5>
                        <ul>${opcao2.vantagens.map(v => `<li>${v}</li>`).join('')}</ul>
                    </div>
                    <div class="desvantagens">
                        <h5>Desvantagens:</h5>
                        <ul>${opcao2.desvantagens.map(d => `<li>${d}</li>`).join('')}</ul>
                    </div>
                </div>
            `;

            const opcao3 = result.comparacao.opcao_3_oficina_antecipada;
            opcoesGrid.innerHTML += `
                <div class="opcao-card">
                    <h4>üîß Op√ß√£o 3: Oficina Antecipada</h4>
                    <div class="opcao-valor">R$ ${opcao3.valor_autorizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    <div class="opcao-info">Prazo: ${opcao3.prazo}</div>
                    ${opcao3.custo_carro_reserva > 0 ? `<div class="opcao-info">Carro Reserva: R$ ${opcao3.custo_carro_reserva.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>` : ''}
                    ${opcao3.custo_carro_reserva > 0 ? `<div class="opcao-info" style="font-weight: bold; font-size: 1.1em; color: #764ba2; margin-top: 8px;">TOTAL: R$ ${opcao3.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>` : ''}
                </div>
            `;

            document.getElementById('recomendacao').innerHTML = 
                `<div class="alert alert-warning"><strong>Recomenda√ß√£o:</strong> ${result.comparacao.recomendacao}</div>`;

            const fin = result.acordo_associado.financiamento;
            document.getElementById('valorOperacao').textContent = 
                'R$ ' + fin.valor_operacao.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('taxaJuros').textContent = 
                fin.taxa_mensal_pct.toFixed(2) + '% ao m√™s';
            document.getElementById('totalPagar').textContent = 
                'R$ ' + fin.total_geral.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('custoFinanceiro').textContent = 
                'R$ ' + fin.custo_financeiro.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + 
                ' (' + fin.percentual_custo.toFixed(2) + '%)';

            const tabelaParcelas = document.getElementById('tabelaParcelas').querySelector('tbody');
            tabelaParcelas.innerHTML = '';
            fin.parcelas.forEach(p => {
                tabelaParcelas.innerHTML += `
                    <tr>
                        <td>${p.numero}¬™</td>
                        <td>${p.vencimento}</td>
                        <td>R$ ${p.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
        }

        function gerarConteudoImpressao() {
            // Coletar dados do formul√°rio
            const dados = {
                nome: document.getElementById('nome_beneficiario').value || 'N√£o informado',
                placa: document.getElementById('placa').value || 'N√£o informado',
                veiculo: document.getElementById('veiculo').value || 'N√£o informado',
                data: document.getElementById('data_sinistro').value,
                regulagem: parseFloat(document.getElementById('valor_regulagem').value) || 0,
                participacao: parseFloat(document.getElementById('valor_participacao').value) || 0,
                orcamento: parseFloat(document.getElementById('orcamento_oficina').value) || 0,
                diasRep: document.getElementById('dias_reparacao').value || '15',
                diasCarro: parseInt(document.getElementById('dias_carro_reserva').value) || 0
            };
            
            // Calcular valores
            const valorBase = dados.regulagem - dados.participacao;
            const custoCarroReserva = dados.diasCarro * 75;
            
            // Op√ß√£o 1
            const op1Custo = valorBase;
            const op1Total = op1Custo + custoCarroReserva;
            
            // Op√ß√£o 2 (usar valores calculados se dispon√≠veis)
            const op2Valor = window.ultimoCalculo?.opcao2_valor_recebido || valorBase * 0.65;
            
            // Op√ß√£o 3
            const op3Valor = window.ultimoCalculo?.opcao3_valor_autorizado || (dados.orcamento > 0 ? dados.orcamento * 0.59 : valorBase * 0.59);
            const op3Total = op3Valor + custoCarroReserva;
            
            // Determinar recomendada
            const opcoes = [
                { id: 1, nome: 'Op√ß√£o 1 (Aguardar Reparo)', valor: op1Total },
                { id: 2, nome: 'Op√ß√£o 2 (Acordo em Dinheiro)', valor: op2Valor },
                { id: 3, nome: 'Op√ß√£o 3 (Oficina Antecipada)', valor: op3Total }
            ];
            const menor = opcoes.reduce((min, op) => op.valor < min.valor ? op : min);
            
            // Formatar data
            const formatData = (d) => {
                if (!d) return 'N√£o informado';
                const [a, m, dia] = d.split('-');
                return `${dia}/${m}/${a}`;
            };
            
            // Formatar moeda
            const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
            
            // Gerar HTML
            return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio SMA - ${dados.nome}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        @page { size: A4; margin: 15mm; }
        body { font-family: Arial, sans-serif; font-size: 11pt; color: #333; background: white; padding: 20px; }
        .header { text-align: center; padding: 20px 0; border-bottom: 3px solid #2c5aa0; margin-bottom: 25px; }
        .header h1 { color: #2c5aa0; font-size: 20pt; margin-bottom: 5px; }
        .header .subtitle { color: #666; font-size: 11pt; margin-bottom: 15px; }
        .header .nome { background: #2c5aa0; color: white; padding: 10px 20px; display: inline-block; border-radius: 5px; font-size: 14pt; font-weight: bold; margin-top: 10px; }
        .section { margin-bottom: 25px; page-break-inside: avoid; }
        .section-title { background: #2c5aa0; color: white; padding: 8px 15px; font-size: 13pt; font-weight: bold; margin-bottom: 10px; border-radius: 3px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        table th { background: #f0f0f0; color: #333; font-weight: bold; text-align: left; padding: 10px; border: 1px solid #ddd; }
        table td { padding: 10px; border: 1px solid #ddd; }
        table tr:nth-child(even) { background: #f9f9f9; }
        .valor-destaque { font-weight: bold; color: #2c5aa0; font-size: 12pt; }
        .total-row { background: #e8f0fe !important; font-weight: bold; }
        .total-row td { color: #2c5aa0; font-size: 12pt; }
        .opcao-card { border: 2px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; }
        .opcao-card.recomendada { border-color: #4caf50; background: #f1f8f4; }
        .opcao-card .opcao-header { font-size: 13pt; font-weight: bold; color: #2c5aa0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #ddd; }
        .opcao-card.recomendada .opcao-header { color: #4caf50; }
        .opcao-card .badge { background: #4caf50; color: white; padding: 3px 10px; border-radius: 3px; font-size: 9pt; margin-left: 10px; }
        .opcao-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .opcao-info-item { padding: 8px; background: white; border-radius: 3px; }
        .opcao-info-label { font-size: 9pt; color: #666; margin-bottom: 3px; }
        .opcao-info-value { font-size: 11pt; font-weight: bold; color: #333; }
        .recomendacao-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 3px; }
        .recomendacao-box strong { color: #856404; font-size: 12pt; }
        .footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center; font-size: 9pt; color: #666; }
        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ Calculadora SMA</h1>
        <div class="subtitle">Socorro M√∫tuo Acordo - Movimento Mais Brasil</div>
        <div class="nome">${dados.nome}</div>
    </div>
    
    <div class="section">
        <div class="section-title">üìã Dados do Sinistro</div>
        <table>
            <tr><th style="width:40%">Item</th><th>Descri√ß√£o</th></tr>
            <tr><td>Associado</td><td>${dados.nome}</td></tr>
            <tr><td>Ve√≠culo</td><td>${dados.veiculo}</td></tr>
            <tr><td>Placa</td><td>${dados.placa}</td></tr>
            <tr><td>Data do Sinistro</td><td>${formatData(dados.data)}</td></tr>
            <tr><td>Valor da Regulagem</td><td class="valor-destaque">${fmt(dados.regulagem)}</td></tr>
            <tr><td>Valor da Participa√ß√£o/Franquia</td><td class="valor-destaque">${fmt(dados.participacao)}</td></tr>
            <tr><td>Or√ßamento da Oficina/CILIA</td><td>${dados.orcamento > 0 ? fmt(dados.orcamento) : 'N√£o informado'}</td></tr>
            <tr><td>Dias Previstos para Repara√ß√£o</td><td>${dados.diasRep}</td></tr>
            <tr><td>Dias de Carro Reserva</td><td>${dados.diasCarro}</td></tr>
        </table>
    </div>
    
    <div class="section">
        <div class="section-title">üíµ Valor Base para C√°lculo</div>
        <table>
            <tr class="total-row"><td style="width:70%">Valor Base (Regulagem - Participa√ß√£o)</td><td class="valor-destaque">${fmt(valorBase)}</td></tr>
        </table>
    </div>
    
    <div class="section">
        <div class="section-title">‚ö° Op√ß√µes de Pagamento</div>
        
        <div class="opcao-card ${menor.id === 1 ? 'recomendada' : ''}">
            <div class="opcao-header">üöó Op√ß√£o 1: Aguardar Reparo${menor.id === 1 ? ' <span class="badge">‚úì RECOMENDADA</span>' : ''}</div>
            <div class="opcao-info">
                <div class="opcao-info-item"><div class="opcao-info-label">Prazo</div><div class="opcao-info-value">${dados.diasRep} dias √∫teis</div></div>
                <div class="opcao-info-item"><div class="opcao-info-label">Custo do Sinistro</div><div class="opcao-info-value">${fmt(op1Custo)}</div></div>
                <div class="opcao-info-item"><div class="opcao-info-label">Carro Reserva</div><div class="opcao-info-value">${fmt(custoCarroReserva)}</div></div>
                <div class="opcao-info-item"><div class="opcao-info-label">TOTAL</div><div class="opcao-info-value" style="color:#2c5aa0;font-size:13pt">${fmt(op1Total)}</div></div>
            </div>
        </div>
        
        <div class="opcao-card ${menor.id === 2 ? 'recomendada' : ''}">
            <div class="opcao-header">üí∞ Op√ß√£o 2: Acordo em Dinheiro${menor.id === 2 ? ' <span class="badge">‚úì RECOMENDADA</span>' : ''}</div>
            <div class="opcao-info">
                <div class="opcao-info-item"><div class="opcao-info-label">Valor Recebido</div><div class="opcao-info-value" style="color:#2c5aa0;font-size:13pt">${fmt(op2Valor)}</div></div>
                <div class="opcao-info-item"><div class="opcao-info-label">Prazo</div><div class="opcao-info-value">7 a 10 dias ap√≥s acordo assinado</div></div>
            </div>
        </div>
        
        <div class="opcao-card ${menor.id === 3 ? 'recomendada' : ''}">
            <div class="opcao-header">üîß Op√ß√£o 3: Oficina Antecipada${menor.id === 3 ? ' <span class="badge">‚úì RECOMENDADA</span>' : ''}</div>
            <div class="opcao-info">
                <div class="opcao-info-item"><div class="opcao-info-label">Valor Autorizado</div><div class="opcao-info-value">${fmt(op3Valor)}</div></div>
                <div class="opcao-info-item"><div class="opcao-info-label">Prazo</div><div class="opcao-info-value">At√© 10 dias ap√≥s finaliza√ß√£o</div></div>
                <div class="opcao-info-item"><div class="opcao-info-label">Carro Reserva</div><div class="opcao-info-value">${fmt(custoCarroReserva)}</div></div>
                <div class="opcao-info-item"><div class="opcao-info-label">TOTAL</div><div class="opcao-info-value" style="color:#2c5aa0;font-size:13pt">${fmt(op3Total)}</div></div>
            </div>
        </div>
    </div>
    
    <div class="recomendacao-box">
        <strong>üí° Recomenda√ß√£o:</strong> ${menor.nome} √© mais vantajosa (menor valor: ${fmt(menor.valor)})
    </div>
    
    <div class="footer">
        <div style="margin-bottom:10px"><strong>Data de Gera√ß√£o:</strong> ${new Date().toLocaleString('pt-BR')}</div>
        <div>Calculadora SMA - Socorro M√∫tuo Acordo<br>Movimento Mais Brasil - Antecipa√ß√£o de Valores de Reparo</div>
    </div>
</body>
</html>`;
        }
        
        function imprimirResultado() {
            const conteudo = gerarConteudoImpressao();
            const janelaImpressao = window.open('', '_blank', 'width=800,height=600');
            janelaImpressao.document.write(conteudo);
            janelaImpressao.document.close();
            setTimeout(() => {
                janelaImpressao.focus();
                janelaImpressao.print();
            }, 250);
        }

        function gerarPDF() {
            const conteudo = gerarConteudoImpressao();
            const nomeBeneficiario = document.getElementById('nome_beneficiario').value || 'Associado';
            const nomeArquivo = `Relatorio_SMA_${nomeBeneficiario.replace(/\s+/g, '_')}.html`;
            
            const blob = new Blob([conteudo], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Arquivo HTML gerado!\n\nüìÑ Para converter em PDF:\n1. Abra o arquivo baixado\n2. Pressione Ctrl+P (ou Cmd+P no Mac)\n3. Selecione "Salvar como PDF"\n4. Clique em "Salvar"');
        }
    </script>
</body>
</html>

