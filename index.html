<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora SMA - Movimento Mais Brasil</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .header h1 { color: #667eea; margin-bottom: 10px; }
        .header p { color: #666; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #764ba2;
        }
        .form-section { margin-bottom: 25px; }
        .form-section h3 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        input[type="number"],
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            background: #764ba2;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background 0.3s;
        }
        .btn:hover { background: #667eea; }
        .btn-action {
            background: white;
            color: #764ba2;
            padding: 10px 20px;
            border: 2px solid #764ba2;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-action:hover {
            background: #764ba2;
            color: white;
        }
        .resultado { display: none; }
        .resultado.show { display: block; }
        .valor-destaque {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .valor-destaque h3 { color: #667eea; margin-bottom: 10px; }
        .valor-destaque .valor {
            font-size: 32px;
            font-weight: bold;
            color: #764ba2;
        }
        .opcoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .opcao-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .opcao-card.destaque {
            border-color: #764ba2;
            background: #f3e5f5;
        }
        .opcao-card h4 { color: #667eea; margin-bottom: 10px; }
        .opcao-valor {
            font-size: 24px;
            font-weight: bold;
            color: #764ba2;
            margin: 10px 0;
        }
        .opcao-info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .vantagens, .desvantagens { margin-top: 15px; }
        .vantagens h5 { color: #4caf50; margin-bottom: 5px; }
        .desvantagens h5 { color: #f44336; margin-bottom: 5px; }
        .vantagens ul, .desvantagens ul {
            list-style: none;
            padding-left: 0;
        }
        .vantagens li::before {
            content: "‚úì ";
            color: #4caf50;
            font-weight: bold;
        }
        .desvantagens li::before {
            content: "‚úó ";
            color: #f44336;
            font-weight: bold;
        }
        .tabela-parcelas {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .tabela-parcelas th, .tabela-parcelas td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .tabela-parcelas th {
            background: #f5f5f5;
            font-weight: 600;
            color: #667eea;
        }
        .info-box {
            background: #e8eaf6;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #764ba2;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 1200px) {
            .main-content { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .opcoes-grid { grid-template-columns: 1fr; }
        }
        @media print {
            .header, .card:first-child, .btn, .btn-action { display: none !important; }
            body { background: white; padding: 0; }
            .main-content { grid-template-columns: 1fr; }
            .card { box-shadow: none; page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Calculadora SMA - Socorro M√∫tuo Acordo</h1>
            <p>Movimento Mais Brasil - Antecipa√ß√£o de Valores de Reparo</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>üìã Dados do Sinistro</h2>
                <form id="formCalculadora">
                    <div class="form-section">
                        <h3>üë§ Dados do Benefici√°rio</h3>
                        <div class="form-group">
                            <label>Nome do Benefici√°rio: *</label>
                            <input type="text" id="nome_beneficiario" required>
                        </div>
                        <div class="form-group">
                            <label>Placa do Ve√≠culo: *</label>
                            <input type="text" id="placa_veiculo" required maxlength="7" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Ve√≠culo (Marca/Modelo): *</label>
                            <input type="text" id="veiculo" required placeholder="Ex: CHEVROLET ONIX">
                        </div>
                        <div class="form-group">
                            <label>Data da Abertura do Sinistro: *</label>
                            <input type="date" id="data_sinistro" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Valores do Sinistro</h3>
                        <div class="form-group">
                            <label>Valor da Regulagem (R$): *</label>
                            <input type="number" id="valor_regulagem" step="0.01" required>
                            <small style="color: #666;">Valor aprovado pelo regulador/perito</small>
                        </div>
                        <div class="form-group">
                            <label>Valor da Participa√ß√£o/Franquia (R$): *</label>
                            <input type="number" id="valor_participacao" step="0.01" value="0" required>
                            <small style="color: #666;">Cota de participa√ß√£o do associado</small>
                        </div>
                        <div class="form-group">
                            <label>Or√ßamento da Oficina/CILIA (R$):</label>
                            <input type="number" id="orcamento_oficina" step="0.01">
                            <small style="color: #666;">Se n√£o tiver, deixe em branco</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Prazos</h3>
                        <div class="form-group">
                            <label>Dias Previstos para Repara√ß√£o:</label>
                            <input type="number" id="dias_reparo" value="15" min="1">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Contraproposta (Opcional)</h3>
                        <div class="form-group">
                            <label>Valor da Contraproposta (R$):</label>
                            <input type="number" id="contraproposta" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Configura√ß√µes do Financiamento</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Taxa de Juros Mensal (%):</label>
                                <input type="number" id="taxa_juros" step="0.01" min="3.95" max="5" value="3.95" required>
                                <small style="color: #666;">Entre 3,95% e 5%</small>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Parcelas:</label>
                                <input type="number" id="n_parcelas" value="4" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                                <small style="color: #666;">Fixo em 4 parcelas</small>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn">üßÆ Calcular Valores do Acordo</button>
                </form>
            </div>

            <div class="card resultado" id="resultado">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üí∞ Resultado do C√°lculo</h2>
                    <div>
                        <button onclick="imprimirResultado()" class="btn-action" style="margin-right: 10px;">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button onclick="gerarPDF()" class="btn-action">
                            üìÑ Gerar PDF
                        </button>
                    </div>
                </div>
                
                <div id="observacoes"></div>

                <div id="dadosBeneficiario" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #764ba2; padding-bottom: 8px;">üë§ Dados do Benefici√°rio</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Nome:</strong>
                            <div id="dadoNome" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Placa:</strong>
                            <div id="dadoPlaca" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Ve√≠culo:</strong>
                            <div id="dadoVeiculo" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Data do Sinistro:</strong>
                            <div id="dadoDataSinistro" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                    </div>
                </div>

                <div class="valor-destaque">
                    <h3>Valor Base para C√°lculo</h3>
                    <div class="valor" id="valorLiquido">R$ 0,00</div>
                </div>

                <h3>‚ö° Op√ß√µes de Pagamento</h3>
                <div class="opcoes-grid" id="opcoesGrid"></div>

                <div id="recomendacao"></div>

                <h3>üí≥ Uso da Associa√ß√£o (Detalhamento do Financiamento - Acordo)</h3>
                <div class="info-box">
                    <strong>Valor da Opera√ß√£o:</strong> <span id="valorOperacao"></span><br>
                    <strong>Taxa de Juros:</strong> <span id="taxaJuros"></span><br>
                    <strong>Total a Pagar:</strong> <span id="totalPagar"></span><br>
                    <strong>Custo Financeiro:</strong> <span id="custoFinanceiro"></span>
                </div>

                <h4>Parcelas:</h4>
                <table class="tabela-parcelas" id="tabelaParcelas">
                    <thead>
                        <tr>
                            <th>Parcela</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('formCalculadora');
        const resultado = document.getElementById('resultado');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const dados = {
                valor_regulagem: parseFloat(document.getElementById('valor_regulagem').value),
                valor_participacao: parseFloat(document.getElementById('valor_participacao').value),
                orcamento_oficina: parseFloat(document.getElementById('orcamento_oficina').value) || parseFloat(document.getElementById('valor_regulagem').value),
                dias_reparo: parseInt(document.getElementById('dias_reparo').value),
                contraproposta: parseFloat(document.getElementById('contraproposta').value),
                taxa_juros: parseFloat(document.getElementById('taxa_juros').value) / 100,
                n_parcelas: parseInt(document.getElementById('n_parcelas').value)
            };

            try {
                const result = calcularSMA(dados);
                exibirResultado(result);
            } catch (error) {
                alert('Erro ao calcular: ' + error.message);
            }
        });

        function calcularSMA(dados) {
            // C√°lculos da Calculadora SMA - F√≥rmulas baseadas na planilha original
            const valor_regulagem = dados.valor_regulagem;
            const valor_participacao = dados.valor_participacao;
            const orcamento_oficina = dados.orcamento_oficina;
            const dias_reparo = dados.dias_reparo;
            const contraproposta = dados.contraproposta || 0;
            const taxa_juros = dados.taxa_juros;
            const n_parcelas = dados.n_parcelas;

            // C√°lculos intermedi√°rios baseados na planilha original
            // H48 = C4 (Regulagem), H49 = C6 (Or√ßamento)
            const h48 = valor_regulagem;
            const h49 = orcamento_oficina;
            const median_valor = (h48 + h49) / 2; // MEDIAN de 2 valores

            // Valores l√≠quidos
            // C21 = (MEDIAN(H48:H49) - C5) * 0.8
            // H21 = (MEDIAN(H48:H49) - C5) * 0.75
            const c21_valor_liquido_80 = (median_valor - valor_participacao) * 0.8;
            const h21_valor_liquido_75 = (median_valor - valor_participacao) * 0.75;

            // Taxas/Custos (C35 e H35)
            // Baseado na an√°lise da planilha: aproximadamente 13.5% do valor l√≠quido
            const taxa_c35 = c21_valor_liquido_80 * 0.1353;
            const taxa_h35 = h21_valor_liquido_75 * 0.1465;

            // Valores finais
            // C15 = C21 - C35 (Valor para Acordo com Associado)
            // H16 = H21 - H35 (Valor para Autoriza√ß√£o na Oficina)
            const valor_acordo_associado = c21_valor_liquido_80 - taxa_c35;
            const valor_autorizacao_oficina = h21_valor_liquido_75 - taxa_h35;

            // Op√ß√£o 1: Reparo em Oficina (Aguardar)
            const opcao1_valor_autorizado = orcamento_oficina;
            const opcao1_prazo = `${dias_reparo} dias √∫teis`;

            // Op√ß√£o 2: Acordo em Dinheiro
            const opcao2_valor_base = valor_acordo_associado;
            const opcao2_valor_recebido = contraproposta > 0 ? contraproposta : opcao2_valor_base;
            const opcao2_prazo = "7 a 10 dias ap√≥s acordo assinado";

            // Op√ß√£o 3: Oficina Antecipada
            const opcao3_valor_autorizado = valor_autorizacao_oficina;
            const opcao3_prazo = "At√© 10 dias ap√≥s finaliza√ß√£o do servi√ßo";

            // Financiamento
            const valor_operacao = opcao2_valor_recebido;
            const taxa_mensal_pct = taxa_juros * 100;
            const valor_parcela = valor_operacao * (taxa_juros * Math.pow(1 + taxa_juros, n_parcelas)) / (Math.pow(1 + taxa_juros, n_parcelas) - 1);
            const total_geral = valor_parcela * n_parcelas;
            const custo_financeiro = total_geral - valor_operacao;
            const percentual_custo = (custo_financeiro / valor_operacao) * 100;

            // Gerar parcelas
            const parcelas = [];
            const hoje = new Date();
            for (let i = 1; i <= n_parcelas; i++) {
                const vencimento = new Date(hoje);
                vencimento.setMonth(vencimento.getMonth() + i);
                parcelas.push({
                    numero: i,
                    vencimento: vencimento.toLocaleDateString('pt-BR'),
                    valor: valor_parcela
                });
            }

            return {
                observacoes: [
                    "C√°lculo baseado nos valores informados",
                    "Taxas e prazos podem variar conforme regulamento"
                ],
                calculos: {
                    valor_liquido: h21_valor_liquido_75  // Valor L√≠quido da REGULAGEM (H21)
                },
                comparacao: {
                    opcao_1_aguardar_reparo: {
                        prazo: opcao1_prazo,
                        custo: valor_regulagem - valor_participacao,
                        vantagens: ["Ve√≠culo reparado", "Sem desembolso imediato"],
                        desvantagens: ["Aguardar reparo", "Sem dinheiro em m√£os"]
                    },
                    opcao_2_acordo_dinheiro: {
                        valor_recebido: opcao2_valor_recebido,
                        prazo: opcao2_prazo,
                        vantagens: ["Dinheiro imediato", "Liberdade de escolha"],
                        desvantagens: ["Valor pode ser menor", "Responsabilidade pelo reparo"]
                    },
                    opcao_3_oficina_antecipada: {
                        valor_autorizado: opcao3_valor_autorizado,
                        prazo: opcao3_prazo
                    },
                    recomendacao: opcao2_valor_recebido > opcao1_valor_autorizado * 0.8 ? 
                        "Op√ß√£o 2 (Acordo em Dinheiro) oferece melhor custo-benef√≠cio" : 
                        "Op√ß√£o 1 (Aguardar Reparo) √© mais vantajosa"
                },
                acordo_associado: {
                    financiamento: {
                        valor_operacao: valor_operacao,
                        taxa_mensal_pct: taxa_mensal_pct,
                        total_geral: total_geral,
                        custo_financeiro: custo_financeiro,
                        percentual_custo: percentual_custo,
                        parcelas: parcelas
                    }
                }
            };
        }

        function exibirResultado(result) {
            resultado.classList.add('show');
            resultado.scrollIntoView({ behavior: 'smooth' });

            // Preencher dados do benefici√°rio
            document.getElementById('dadoNome').textContent = document.getElementById('nome_beneficiario').value;
            document.getElementById('dadoPlaca').textContent = document.getElementById('placa_veiculo').value.toUpperCase();
            document.getElementById('dadoVeiculo').textContent = document.getElementById('veiculo').value;
            const dataSinistro = document.getElementById('data_sinistro').value;
            if (dataSinistro) {
                const [ano, mes, dia] = dataSinistro.split('-');
                document.getElementById('dadoDataSinistro').textContent = `${dia}/${mes}/${ano}`;
            }

            const observacoes = document.getElementById('observacoes');
            observacoes.innerHTML = '';
            result.observacoes.forEach(obs => {
                observacoes.innerHTML += `<div class="alert alert-info">${obs}</div>`;
            });

            document.getElementById('valorLiquido').textContent = 
                'R$ ' + result.calculos.valor_liquido.toLocaleString('pt-BR', {minimumFractionDigits: 2});

            const opcoesGrid = document.getElementById('opcoesGrid');
            opcoesGrid.innerHTML = '';

            const opcao1 = result.comparacao.opcao_1_aguardar_reparo;
            opcoesGrid.innerHTML += `
                <div class="opcao-card">
                    <h4>üìÖ Op√ß√£o 1: Aguardar Reparo</h4>
                    <div class="opcao-valor">Ve√≠culo Reparado</div>
                    <div class="opcao-info">Prazo: ${opcao1.prazo}</div>
                    <div class="opcao-info">Custo: R$ ${opcao1.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="vantagens">
                        <h5>Vantagens:</h5>
                        <ul>${opcao1.vantagens.map(v => `<li>${v}</li>`).join('')}</ul>
                    </div>
                    <div class="desvantagens">
                        <h5>Desvantagens:</h5>
                        <ul>${opcao1.desvantagens.map(d => `<li>${d}</li>`).join('')}</ul>
                    </div>
                </div>
            `;

            const opcao2 = result.comparacao.opcao_2_acordo_dinheiro;
            opcoesGrid.innerHTML += `
                <div class="opcao-card destaque">
                    <h4>üí∏ Op√ß√£o 2: Acordo em Dinheiro</h4>
                    <div class="opcao-valor">R$ ${opcao2.valor_recebido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    <div class="opcao-info">Prazo: ${opcao2.prazo}</div>
                    <div class="vantagens">
                        <h5>Vantagens:</h5>
                        <ul>${opcao2.vantagens.map(v => `<li>${v}</li>`).join('')}</ul>
                    </div>
                    <div class="desvantagens">
                        <h5>Desvantagens:</h5>
                        <ul>${opcao2.desvantagens.map(d => `<li>${d}</li>`).join('')}</ul>
                    </div>
                </div>
            `;

            const opcao3 = result.comparacao.opcao_3_oficina_antecipada;
            opcoesGrid.innerHTML += `
                <div class="opcao-card">
                    <h4>üîß Op√ß√£o 3: Oficina Antecipada</h4>
                    <div class="opcao-valor">R$ ${opcao3.valor_autorizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    <div class="opcao-info">Prazo: ${opcao3.prazo}</div>
                </div>
            `;

            document.getElementById('recomendacao').innerHTML = 
                `<div class="alert alert-warning"><strong>Recomenda√ß√£o:</strong> ${result.comparacao.recomendacao}</div>`;

            const fin = result.acordo_associado.financiamento;
            document.getElementById('valorOperacao').textContent = 
                'R$ ' + fin.valor_operacao.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('taxaJuros').textContent = 
                fin.taxa_mensal_pct.toFixed(2) + '% ao m√™s';
            document.getElementById('totalPagar').textContent = 
                'R$ ' + fin.total_geral.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('custoFinanceiro').textContent = 
                'R$ ' + fin.custo_financeiro.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + 
                ' (' + fin.percentual_custo.toFixed(2) + '%)';

            const tabelaParcelas = document.getElementById('tabelaParcelas').querySelector('tbody');
            tabelaParcelas.innerHTML = '';
            fin.parcelas.forEach(p => {
                tabelaParcelas.innerHTML += `
                    <tr>
                        <td>${p.numero}¬™</td>
                        <td>${p.vencimento}</td>
                        <td>R$ ${p.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
        }

        function imprimirResultado() {
            window.print();
        }

        function gerarPDF() {
            const resultadoDiv = document.getElementById('resultado');
            const valorRegulagem = document.getElementById('valor_regulagem').value;
            
            const conteudoPDF = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>C√°lculo SMA - R$ ${valorRegulagem}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; text-align: center; }
                        h2 { color: #764ba2; border-bottom: 2px solid #764ba2; padding-bottom: 5px; }
                        .info { background: #e8eaf6; padding: 15px; margin: 10px 0; border-radius: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f5f5f5; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>Calculadora SMA - Movimento Mais Brasil</h1>
                    ${resultadoDiv.innerHTML}
                </body>
                </html>
            `;
            
            const blob = new Blob([conteudoPDF], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Calculo_SMA_${valorRegulagem.replace('.', '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Arquivo HTML gerado! Voc√™ pode abrir e salvar como PDF (Ctrl+P > Salvar como PDF)');
        }
    </script>
</body>
</html>

