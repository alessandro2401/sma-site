
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora SMA - Movimento Mais Brasil</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .header h1 { color: #667eea; margin-bottom: 10px; }
        .header p { color: #666; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #764ba2;
        }
        .form-section { margin-bottom: 25px; }
        .form-section h3 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        input[type="number"],
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            background: #764ba2;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background 0.3s;
        }
        .btn:hover { background: #667eea; }
        .btn-action {
            background: white;
            color: #764ba2;
            padding: 10px 20px;
            border: 2px solid #764ba2;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-action:hover {
            background: #764ba2;
            color: white;
        }
        .resultado { display: none; }
        .resultado.show { display: block; }
        .valor-destaque {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .valor-destaque h3 { color: #667eea; margin-bottom: 10px; }
        .valor-destaque .valor {
            font-size: 32px;
            font-weight: bold;
            color: #764ba2;
        }
        .opcoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .opcao-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .opcao-card.destaque {
            border-color: #764ba2;
            background: #f3e5f5;
        }
        .opcao-card h4 { color: #667eea; margin-bottom: 10px; }
        .opcao-valor {
            font-size: 24px;
            font-weight: bold;
            color: #764ba2;
            margin: 10px 0;
        }
        .opcao-info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .vantagens, .desvantagens { margin-top: 15px; }
        .vantagens h5 { color: #4caf50; margin-bottom: 5px; }
        .desvantagens h5 { color: #f44336; margin-bottom: 5px; }
        .vantagens ul, .desvantagens ul {
            list-style: none;
            padding-left: 0;
        }
        .vantagens li::before {
            content: "‚úì ";
            color: #4caf50;
            font-weight: bold;
        }
        .desvantagens li::before {
            content: "‚úó ";
            color: #f44336;
            font-weight: bold;
        }
        .tabela-parcelas {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .tabela-parcelas th, .tabela-parcelas td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .tabela-parcelas th {
            background: #f5f5f5;
            font-weight: 600;
            color: #667eea;
        }
        .info-box {
            background: #e8eaf6;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #764ba2;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 1200px) {
            .main-content { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .opcoes-grid { grid-template-columns: 1fr; }
        }
        /* Estilos para feedback de valida√ß√£o da contraproposta */
        .feedback-validacao {
            margin-top: 10px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }
        .feedback-validacao.show { display: block; }
        .feedback-aprovado {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .feedback-reprovado {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .feedback-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
            font-size: 13px;
            margin-top: 8px;
            padding: 10px;
            border-radius: 5px;
        }
        @media print {
            .header, .card:first-child, .btn, .btn-action { display: none !important; }
            body { background: white; padding: 0; }
            .main-content { grid-template-columns: 1fr; }
            .card { box-shadow: none; page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><svg style="display: inline-block; vertical-align: middle; margin-right: 8px;" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg> C√°lculo para Indeniza√ß√£o financeira</h1>
            <p>Movimento Mais Brasil - Antecipa√ß√£o de Valores de Reparo</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2><svg style="display: inline-block; vertical-align: middle; margin-right: 8px;" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> Dados do Sinistro</h2>
                <form id="formCalculadora">
                    <div class="form-section">
                        <h3><svg style="display: inline-block; vertical-align: middle; margin-right: 6px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Dados do Benefici√°rio</h3>
                        <div class="form-group">
                            <label>Nome do Benefici√°rio: *</label>
                            <input type="text" id="nome_beneficiario" required>
                        </div>
                        <div class="form-group">
                            <label>Placa do Ve√≠culo: *</label>
                            <input type="text" id="placa_veiculo" required maxlength="7" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Ve√≠culo (Marca/Modelo): *</label>
                            <input type="text" id="veiculo" required placeholder="Ex: CHEVROLET ONIX">
                        </div>
                        <div class="form-group">
                            <label>Data da Abertura do Sinistro: *</label>
                            <input type="date" id="data_sinistro" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Valores do Sinistro</h3>
                        <div class="form-group">
                            <label>Valor da Regulagem (R$): *</label>
                            <input type="number" id="valor_regulagem" step="0.01" required>
                            <small style="color: #666;">Valor aprovado pelo regulador/perito</small>
                        </div>
                        <div class="form-group">
                            <label>Valor da Participa√ß√£o/Franquia (R$): *</label>
                            <input type="number" id="valor_participacao" step="0.01" value="0" required>
                            <small style="color: #666;">Cota de participa√ß√£o do associado</small>
                        </div>
                        <div class="form-group">
                            <label>Or√ßamento da Oficina/CILIA (R$):</label>
                            <input type="number" id="orcamento_oficina" step="0.01">
                            <small style="color: #666;">Se n√£o tiver, deixe em branco</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Prazos</h3>
                        <div class="form-group">
                            <label>Dias Previstos para Repara√ß√£o:</label>
                            <input type="number" id="dias_reparo" value="15" min="1">
                        </div>
                        <div class="form-group">
                            <label>Dias de Carro Reserva:</label>
                            <input type="number" id="dias_carro_reserva" value="0" min="0" placeholder="Ex: 7, 10, 15...">
                            <small style="color: #666; font-size: 12px;">Custo: R$ 75,00 por di√°ria</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Configura√ß√µes do Financiamento</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Taxa de Juros Mensal (%):</label>
                                <input type="number" id="taxa_juros" step="0.01" min="3.95" max="5" value="3.95" required>
                                <small style="color: #666;">Entre 3,95% e 5%</small>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Parcelas:</label>
                                <input type="number" id="n_parcelas" value="4" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                                <small style="color: #666;">Fixo em 4 parcelas</small>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn"><svg style="display: inline-block; vertical-align: middle; margin-right: 6px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><rect x="8" y="6" width="8" height="2" rx="1" fill="currentColor"/><line x1="8" y1="12" x2="8" y2="12"/><line x1="12" y1="12" x2="12" y2="12"/><line x1="16" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="12" y1="16" x2="12" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg> Calcular Valores do Acordo</button>
                    
                    <!-- Bot√£o para acessar a planilha -->
                    <a href="https://docs.google.com/spreadsheets/d/15bDgZ7vCWGox7XfGGdNopAqztn5h6NLJKEuPoGzM0qc/edit?usp=sharing" 
                       target="_blank" 
                       class="btn" 
                       style="background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%); margin-top: 15px; display: inline-block; text-decoration: none; text-align: center;">
                        <svg style="display: inline-block; vertical-align: middle; margin-right: 6px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg> Acessar Planilha de Registros
                    </a>
                </form>
            </div>

            <div class="card resultado" id="resultado">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;"><svg style="display: inline-block; vertical-align: middle; margin-right: 8px;" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg> Resultado do C√°lculo</h2>
                    <div>
                        <button onclick="imprimirResultado()" class="btn-action" style="margin-right: 10px;">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button onclick="gerarPDF()" class="btn-action">
                            üìÑ Gerar PDF
                        </button>
                    </div>
                </div>
                
                <div id="observacoes"></div>

                <div id="dadosBeneficiario" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #764ba2; padding-bottom: 8px;"><svg style="display: inline-block; vertical-align: middle; margin-right: 6px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Dados do Benefici√°rio</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Nome:</strong>
                            <div id="dadoNome" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Placa:</strong>
                            <div id="dadoPlaca" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Ve√≠culo:</strong>
                            <div id="dadoVeiculo" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Data do Sinistro:</strong>
                            <div id="dadoDataSinistro" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                    </div>
                </div>

                <div id="dadosSinistro" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #764ba2; padding-bottom: 8px;"><svg style="display: inline-block; vertical-align: middle; margin-right: 6px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg> Valores do Sinistro</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Valor da Regulagem:</strong>
                            <div id="dadoValorRegulagem" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Participa√ß√£o/Franquia:</strong>
                            <div id="dadoParticipacao" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Or√ßamento da Oficina:</strong>
                            <div id="dadoOrcamento" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                    </div>
                </div>

                <div id="dadosPrazos" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #764ba2; padding-bottom: 8px;">‚è±Ô∏è Prazos</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Dias para Repara√ß√£o:</strong>
                            <div id="dadoDiasReparo" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <strong>Dias de Carro Reserva:</strong>
                            <div id="dadoDiasCarroReserva" style="color: #333; margin-top: 5px;">-</div>
                        </div>
                    </div>
                </div>

                <div class="valor-destaque">
                    <h3>Valor Base para C√°lculo</h3>
                    <div class="valor" id="valorLiquido">R$ 0,00</div>
                </div>

                <h3>‚ö° Op√ß√µes de Pagamento</h3>
                <div class="opcoes-grid" id="opcoesGrid"></div>

                <div id="recomendacao"></div>

                <div class="form-section" id="contraproposta-section" style="margin-top: 20px; background: #f9f9f9; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #764ba2; border-bottom: 2px solid #667eea; padding-bottom: 10px;">‚öñÔ∏è An√°lise de Contraproposta</h3>
                    <div class="form-group">
                        <label for="contraproposta_input">Valor Proposto pelo Associado (R$):</label>
                        <input type="number" id="contraproposta_input" step="0.01" placeholder="Insira o valor da contraproposta" style="margin-bottom: 10px;" value="0">
                        <button onclick="validarContraproposta()" style="margin-top: 10px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;"><svg style="display: inline-block; vertical-align: middle; margin-right: 6px;" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><rect x="8" y="6" width="8" height="2" rx="1" fill="currentColor"/><line x1="8" y1="12" x2="8" y2="12"/><line x1="12" y1="12" x2="12" y2="12"/><line x1="16" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="12" y1="16" x2="12" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg> Calcular com Contraproposta</button>
                        <div id="feedback-contraproposta" class="feedback-validacao" style="display: none; margin-top: 15px;"></div>
                        <div id="info-limites" class="feedback-info" style="display: none; margin-top: 15px;">
                            <strong>Faixa de negocia√ß√£o aceit√°vel:</strong><br>
                            M√≠nimo: R$ <span id="limite-minimo">0,00</span><br>
                            M√°ximo: R$ <span id="limite-maximo">0,00</span>
                        </div>
                    </div>
                </div>

                <h3>üí≥ Uso da Associa√ß√£o (Detalhamento do Financiamento - Acordo)</h3>
                <div class="info-box">
                    <strong>Valor da Opera√ß√£o:</strong> <span id="valorOperacao"></span><br>
                    <strong>Taxa de Juros:</strong> <span id="taxaJuros"></span><br>
                    <strong>Total a Pagar:</strong> <span id="totalPagar"></span><br>
                    <strong>Custo Financeiro:</strong> <span id="custoFinanceiro"></span>
                </div>

                <h4>Parcelas:</h4>
                <table class="tabela-parcelas" id="tabelaParcelas">
                    <thead>
                        <tr>
                            <th>Parcela</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('formCalculadora');
        const resultado = document.getElementById('resultado');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const dados = {
                valor_regulagem: parseFloat(document.getElementById('valor_regulagem').value),
                valor_participacao: parseFloat(document.getElementById('valor_participacao').value),
                orcamento_oficina: parseFloat(document.getElementById('orcamento_oficina').value) || parseFloat(document.getElementById('valor_regulagem').value),
                dias_reparo: parseInt(document.getElementById('dias_reparo').value),
                dias_carro_reserva: parseInt(document.getElementById('dias_carro_reserva').value) || 0,
                contraproposta: parseFloat(document.getElementById('contraproposta_input').value) || 0,
                taxa_juros: parseFloat(document.getElementById('taxa_juros').value) / 100,
                n_parcelas: parseInt(document.getElementById('n_parcelas').value)
            };

            try {
                const result = calcularSMA(dados);
                // Salvar resultado para uso na impress√£o
                window.ultimoCalculo = {
                    opcao2_valor_recebido: result.comparacao.opcao_2_acordo_dinheiro.valor_recebido,
                    opcao3_valor_autorizado: result.comparacao.opcao_3_oficina_antecipada.valor_autorizado
                };
                exibirResultado(result);
                // Enviar dados para API do Google Sheets
                enviarParaAPISMA(dados, result);
            } catch (error) {
                alert('Erro ao calcular: ' + error.message);
            }
        });

        // Fun√ß√£o para enviar dados √† API
        async function enviarParaAPISMA(dadosEntrada, resultado) {
            try {
                const dadosAPI = {
                    nomeBeneficiario: document.getElementById('nome_beneficiario').value || '',
                    placaVeiculo: document.getElementById('placa_veiculo').value || '',
                    modeloVeiculo: document.getElementById('veiculo').value || '',
                    dataAberturaSinistro: document.getElementById('data_sinistro').value || '',
                    valorRegulagem: dadosEntrada.valor_regulagem || 0,
                    valorParticipacao: dadosEntrada.valor_participacao || 0,
                    orcamentoOficina: dadosEntrada.orcamento_oficina || 0,
                    valorContraproposta: dadosEntrada.contraproposta || 0,
                    valorMinimoContraproposta: resultado.validacao_contraproposta?.limiteMin || 0,
                    valorMaximoContraproposta: resultado.validacao_contraproposta?.limiteMax || 0,
                    diasReparacao: dadosEntrada.dias_reparo || 0,
                    diasCarroReserva: dadosEntrada.dias_carro_reserva || 0,
                    valorCarroReserva: (dadosEntrada.dias_carro_reserva || 0) * 75,
                    valorBase: resultado.calculos.valor_liquido || 0,
                    opcao1Valor: resultado.comparacao.opcao_1_aguardar_reparo.custo_total || 0,
                    opcao2Valor: resultado.comparacao.opcao_2_acordo_dinheiro.valor_recebido || 0,
                    opcao3Valor: resultado.comparacao.opcao_3_oficina_antecipada.valor_total || 0,
                    opcaoRecomendada: resultado.comparacao.recomendacao || '',
                    valorOperacao: resultado.acordo_associado.financiamento.valor_operacao || 0,
                    taxaJuros: resultado.acordo_associado.financiamento.taxa_mensal_pct || 0,
                    totalPagar: resultado.acordo_associado.financiamento.total_geral || 0,
                    custoFinanceiro: resultado.acordo_associado.financiamento.custo_financeiro || 0,
                    percentualCusto: resultado.acordo_associado.financiamento.percentual_custo || 0,
                    numeroParcelas: resultado.acordo_associado.financiamento.parcelas.length || 0,
                    parcela1Data: resultado.acordo_associado.financiamento.parcelas[0]?.vencimento || '',
                    parcela1Valor: resultado.acordo_associado.financiamento.parcelas[0]?.valor || 0,
                    parcela2Data: resultado.acordo_associado.financiamento.parcelas[1]?.vencimento || '',
                    parcela2Valor: resultado.acordo_associado.financiamento.parcelas[1]?.valor || 0,
                    parcela3Data: resultado.acordo_associado.financiamento.parcelas[2]?.vencimento || '',
                    parcela3Valor: resultado.acordo_associado.financiamento.parcelas[2]?.valor || 0,
                    parcela4Data: resultado.acordo_associado.financiamento.parcelas[3]?.vencimento || '',
                    parcela4Valor: resultado.acordo_associado.financiamento.parcelas[3]?.valor || 0
                };

                const response = await fetch('https://api-calculadoras-sheets.vercel.app/api/registrar-calculo-sma', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosAPI)
                });

                if (!response.ok) {
                    console.error('Erro ao enviar dados para API:', response.statusText);
                }
            } catch (error) {
                console.error('Erro ao enviar dados para API:', error);
            }
        }

        function calcularSMA(dados) {
            // C√°lculos da Calculadora SMA - F√≥rmulas baseadas na planilha original
            const valor_regulagem = dados.valor_regulagem;
            const valor_participacao = dados.valor_participacao;
            const orcamento_oficina = dados.orcamento_oficina;
            const dias_reparo = dados.dias_reparo;
            const dias_carro_reserva = dados.dias_carro_reserva || 0;
            const contraproposta = dados.contraproposta || 0;
            const taxa_juros = dados.taxa_juros;
            const n_parcelas = dados.n_parcelas;
            
            // C√°lculo do Carro Reserva
            const custo_diaria_carro = 75.00;
            const custo_carro_reserva = dias_carro_reserva * custo_diaria_carro;

            // C√°lculos intermedi√°rios baseados na planilha original
            // H48 = C4 (Regulagem), H49 = C6 (Or√ßamento)
            const h48 = valor_regulagem;
            const h49 = orcamento_oficina;
            const median_valor = (h48 + h49) / 2; // MEDIAN de 2 valores

            // Valores l√≠quidos
            // C21 = (MEDIAN(H48:H49) - C5) * 0.8
            // H21 = (MEDIAN(H48:H49) - C5) * 0.75
            const c21_valor_liquido_80 = (median_valor - valor_participacao) * 0.8;
            const h21_valor_liquido_75 = (median_valor - valor_participacao) * 0.75;

            // Taxas/Custos (C35 e H35)
            // Baseado na an√°lise da planilha: aproximadamente 13.5% do valor l√≠quido
            const taxa_c35 = c21_valor_liquido_80 * 0.1353;
            const taxa_h35 = h21_valor_liquido_75 * 0.1465;

            // Valores finais
            // C15 = C21 - C35 (Valor para Acordo com Associado)
            // H16 = H21 - H35 (Valor para Autoriza√ß√£o na Oficina)
            const valor_acordo_associado = c21_valor_liquido_80 - taxa_c35;
            const valor_autorizacao_oficina = h21_valor_liquido_75 - taxa_h35;

            // Op√ß√£o 1: Reparo em Oficina (Aguardar)
            const opcao1_valor_autorizado = orcamento_oficina;
            const opcao1_prazo = `${dias_reparo} dias √∫teis`;

            // Op√ß√£o 2: Acordo em Dinheiro
            const opcao2_valor_base = valor_acordo_associado;
            const opcao2_prazo = "7 a 10 dias ap√≥s acordo assinado";

            // Op√ß√£o 3: Oficina Antecipada
            const opcao3_valor_autorizado = valor_autorizacao_oficina;
            const opcao3_prazo = "At√© 10 dias ap√≥s finaliza√ß√£o do servi√ßo";

            // VALIDA√á√ÉO DA CONTRAPROPOSTA
            // Faixa de negocia√ß√£o: 100% a 112% do valor do acordo calculado
            const limiteInferior = valor_acordo_associado * 1.00;  // 100% do valor do acordo
            const limiteSuperior = valor_acordo_associado * 1.12;  // 112% do valor do acordo (faixa de 12%)
            let validacao_contraproposta = null;
            if (contraproposta > 0) {
                if (contraproposta >= limiteInferior && contraproposta <= limiteSuperior) {
                    validacao_contraproposta = { status: 'aprovada', valor: contraproposta, mensagem: 'Contraproposta APROVADA - Valor dentro da faixa permitida.' };
                } else if (contraproposta < limiteInferior) {
                    validacao_contraproposta = { status: 'reprovada', valor: contraproposta, mensagem: `Contraproposta REPROVADA - Valor R$ ${(limiteInferior - contraproposta).toFixed(2).replace('.', ',')} abaixo do m√≠nimo aceit√°vel.` };
                } else { // maior que o superior
                    validacao_contraproposta = { status: 'reprovada', valor: contraproposta, mensagem: `Contraproposta REPROVADA - Valor R$ ${(contraproposta - limiteSuperior).toFixed(2).replace('.', ',')} acima do m√°ximo permitido.` };
                }
                validacao_contraproposta.limiteMin = limiteInferior;
                validacao_contraproposta.limiteMax = limiteSuperior;
            }

            // Financiamento
            // Define o valor da opera√ß√£o para o financiamento com base na valida√ß√£o
            const valor_operacao = (validacao_contraproposta && validacao_contraproposta.status === 'aprovada') 
                ? validacao_contraproposta.valor 
                : valor_acordo_associado;

            const taxa_mensal_pct = taxa_juros * 100;
            const valor_parcela = valor_operacao * (taxa_juros * Math.pow(1 + taxa_juros, n_parcelas)) / (Math.pow(1 + taxa_juros, n_parcelas) - 1);
            const total_geral = valor_parcela * n_parcelas;
            const custo_financeiro = total_geral - valor_operacao;
            const percentual_custo = (custo_financeiro / valor_operacao) * 100;

            // Gerar parcelas
            const parcelas = [];
            const hoje = new Date();
            for (let i = 1; i <= n_parcelas; i++) {
                const vencimento = new Date(hoje);
                vencimento.setMonth(vencimento.getMonth() + i);
                parcelas.push({
                    numero: i,
                    vencimento: vencimento.toLocaleDateString('pt-BR'),
                    valor: valor_parcela
                });
            }

            return {
                validacao_contraproposta,
                observacoes: [
                    "C√°lculo baseado nos valores informados",
                    "Taxas e prazos podem variar conforme regulamento"
                ],
                calculos: {
                    valor_liquido: h21_valor_liquido_75  // Valor L√≠quido da REGULAGEM (H21)
                },
                comparacao: {
                    opcao_1_aguardar_reparo: {
                        prazo: opcao1_prazo,
                        custo: valor_regulagem - valor_participacao,
                        custo_carro_reserva: custo_carro_reserva,
                        custo_total: (valor_regulagem - valor_participacao) + custo_carro_reserva,
                        vantagens: ["Ve√≠culo reparado", "Sem desembolso imediato"],
                        desvantagens: ["Aguardar reparo", "Sem dinheiro em m√£os"]
                    },
                    opcao_2_acordo_dinheiro: {
                        valor_recebido: valor_acordo_associado,
                        prazo: opcao2_prazo,
                        vantagens: ["Dinheiro imediato", "Liberdade de escolha"],
                        desvantagens: ["Valor pode ser menor", "Responsabilidade pelo reparo"]
                    },
                    opcao_3_oficina_antecipada: {
                        valor_autorizado: valor_autorizacao_oficina,
                        valor_total: valor_autorizacao_oficina + custo_carro_reserva,
                        prazo: opcao3_prazo,
                        vantagens: ["Reparo antecipado", "Menor tempo de espera"],
                        desvantagens: ["Custo financeiro maior"]
                    },
                    recomendacao: (valor_acordo_associado > valor_autorizacao_oficina) ? "Op√ß√£o 2" : "Op√ß√£o 3"
                },
                acordo_associado: {
                    financiamento: {
                        valor_operacao: valor_operacao,
                        taxa_mensal_pct: taxa_mensal_pct.toFixed(2) + '%',
                        total_geral: total_geral,
                        custo_financeiro: custo_financeiro,
                        percentual_custo: percentual_custo.toFixed(2) + '%',
                        parcelas: parcelas
                    }
                }
            };
        }

        function exibirResultado(resultado) {
                        // Exibir feedback da contraproposta
            const feedbackContainer = document.getElementById('feedback-contraproposta');
            const infoLimitesContainer = document.getElementById('info-limites');

            if (resultado.validacao_contraproposta) {
                feedbackContainer.style.display = 'block';
                infoLimitesContainer.style.display = 'block';
                feedbackContainer.textContent = resultado.validacao_contraproposta.mensagem;
                feedbackContainer.className = 'feedback-validacao show';
                
                if (resultado.validacao_contraproposta.status === 'aprovada') {
                    feedbackContainer.classList.add('feedback-aprovado');
                    feedbackContainer.classList.remove('feedback-reprovado');
                } else {
                    feedbackContainer.classList.add('feedback-reprovado');
                    feedbackContainer.classList.remove('feedback-aprovado');
                }

                document.getElementById('limite-minimo').textContent = formatarMoeda(resultado.validacao_contraproposta.limiteMin, '');
                document.getElementById('limite-maximo').textContent = formatarMoeda(resultado.validacao_contraproposta.limiteMax, '');

            } else {
                feedbackContainer.style.display = 'none';
                infoLimitesContainer.style.display = 'none';
            }

            document.getElementById('resultado').classList.add('show');
            document.getElementById('resultado').scrollIntoView({ behavior: 'smooth' });

            // Preencher dados do benefici√°rio
            document.getElementById('dadoNome').textContent = document.getElementById('nome_beneficiario').value;
            document.getElementById('dadoPlaca').textContent = document.getElementById('placa_veiculo').value;
            document.getElementById('dadoVeiculo').textContent = document.getElementById('veiculo').value;
            document.getElementById('dadoDataSinistro').textContent = new Date(document.getElementById('data_sinistro').value + 'T00:00:00').toLocaleDateString('pt-BR');

            // Preencher valores do sinistro
            document.getElementById('dadoValorRegulagem').textContent = formatarMoeda(parseFloat(document.getElementById('valor_regulagem').value));
            document.getElementById('dadoParticipacao').textContent = formatarMoeda(parseFloat(document.getElementById('valor_participacao').value));
            const orcamento = parseFloat(document.getElementById('orcamento_oficina').value) || parseFloat(document.getElementById('valor_regulagem').value);
            document.getElementById('dadoOrcamento').textContent = formatarMoeda(orcamento);

            // Preencher prazos
            document.getElementById('dadoDiasReparo').textContent = document.getElementById('dias_reparo').value + ' dias';
            const diasCarroReserva = document.getElementById('dias_carro_reserva').value || '0';
            document.getElementById('dadoDiasCarroReserva').textContent = diasCarroReserva + ' dias';

            // Preencher observa√ß√µes
            const obsContainer = document.getElementById('observacoes');
            obsContainer.innerHTML = '';
            resultado.observacoes.forEach(obs => {
                const p = document.createElement('p');
                p.className = 'alert alert-info';
                p.textContent = obs;
                obsContainer.appendChild(p);
            });

            // Preencher valor l√≠quido
            document.getElementById('valorLiquido').textContent = formatarMoeda(resultado.calculos.valor_liquido);

            // Preencher op√ß√µes
            const opcoesContainer = document.getElementById('opcoesGrid');
            opcoesContainer.innerHTML = '';
            const opcoes = resultado.comparacao;

            // Card Op√ß√£o 1
            const card1 = criarCardOpcao(
                'Op√ß√£o 1: Aguardar Reparo na Oficina',
                opcoes.opcao_1_aguardar_reparo.custo_total,
                `Custo Total (Pe√ßas + M√£o de Obra): ${formatarMoeda(opcoes.opcao_1_aguardar_reparo.custo)}`,
                `Custo Carro Reserva: ${formatarMoeda(opcoes.opcao_1_aguardar_reparo.custo_carro_reserva)}`,
                `Prazo Estimado: ${opcoes.opcao_1_aguardar_reparo.prazo}`,
                opcoes.opcao_1_aguardar_reparo.vantagens,
                opcoes.opcao_1_aguardar_reparo.desvantagens,
                opcoes.recomendacao === 'Op√ß√£o 1'
            );
            opcoesContainer.appendChild(card1);

            // Card Op√ß√£o 2
            const card2 = criarCardOpcao(
                'Op√ß√£o 2: Acordo em Dinheiro',
                opcoes.opcao_2_acordo_dinheiro.valor_recebido,
                'Valor a ser recebido pelo associado.',
                `Prazo para pagamento: ${opcoes.opcao_2_acordo_dinheiro.prazo}`,
                '',
                opcoes.opcao_2_acordo_dinheiro.vantagens,
                opcoes.opcao_2_acordo_dinheiro.desvantagens,
                opcoes.recomendacao === 'Op√ß√£o 2'
            );
            opcoesContainer.appendChild(card2);

            // Card Op√ß√£o 3
            const card3 = criarCardOpcao(
                'Op√ß√£o 3: Reparo em Oficina com Antecipa√ß√£o',
                opcoes.opcao_3_oficina_antecipada.valor_total,
                `Valor Autorizado para Oficina: ${formatarMoeda(opcoes.opcao_3_oficina_antecipada.valor_autorizado)}`,
                `Custo Carro Reserva: ${formatarMoeda(opcoes.opcao_1_aguardar_reparo.custo_carro_reserva)}`,
                `Prazo para pagamento: ${opcoes.opcao_3_oficina_antecipada.prazo}`,
                opcoes.opcao_3_oficina_antecipada.vantagens,
                opcoes.opcao_3_oficina_antecipada.desvantagens,
                opcoes.recomendacao === 'Op√ß√£o 3'
            );
            opcoesContainer.appendChild(card3);

            // Preencher recomenda√ß√£o
            const recomendacaoContainer = document.getElementById('recomendacao');
            recomendacaoContainer.innerHTML = `
                <div class="alert alert-warning">
                    <strong>Recomenda√ß√£o:</strong> A ${opcoes.recomendacao} parece ser a mais vantajosa neste cen√°rio.
                </div>
            `;

            // Preencher dados do financiamento
            const financiamento = resultado.acordo_associado.financiamento;
            document.getElementById('valorOperacao').textContent = formatarMoeda(financiamento.valor_operacao);
            document.getElementById('taxaJuros').textContent = financiamento.taxa_mensal_pct;
            document.getElementById('totalPagar').textContent = formatarMoeda(financiamento.total_geral);
            document.getElementById('custoFinanceiro').textContent = `${formatarMoeda(financiamento.custo_financeiro)} (${financiamento.percentual_custo})`;

            // Preencher tabela de parcelas
            const tabelaBody = document.getElementById('tabelaParcelas').getElementsByTagName('tbody')[0];
            tabelaBody.innerHTML = '';
            financiamento.parcelas.forEach(p => {
                const row = tabelaBody.insertRow();
                row.insertCell(0).textContent = p.numero;
                row.insertCell(1).textContent = p.vencimento;
                row.insertCell(2).textContent = formatarMoeda(p.valor);
            });
        }

        function criarCardOpcao(titulo, valor, info1, info2, info3, vantagens, desvantagens, destaque) {
            const card = document.createElement('div');
            card.className = 'opcao-card' + (destaque ? ' destaque' : '');
            
            let info3HTML = info3 ? `<p class="opcao-info">${info3}</p>` : '';

            card.innerHTML = `
                <h4>${titulo}</h4>
                <div class="opcao-valor">${formatarMoeda(valor)}</div>
                <p class="opcao-info">${info1}</p>
                <p class="opcao-info">${info2}</p>
                ${info3HTML}
                <div class="vantagens">
                    <h5>Vantagens</h5>
                    <ul>${vantagens.map(v => `<li>${v}</li>`).join('')}</ul>
                </div>
                <div class="desvantagens">
                    <h5>Desvantagens</h5>
                    <ul>${desvantagens.map(d => `<li>${d}</li>`).join('')}</ul>
                </div>
            `;
            return card;
        }

        function formatarMoeda(valor, simbolo = 'R$ ') {
            if (isNaN(valor)) return simbolo + '0,00';
            return simbolo + valor.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+\,)/g, "$1.");
        }

        // Fun√ß√µes de Impress√£o e PDF
        function imprimirResultado() {
            window.print();
        }

        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const resultadoElement = document.getElementById('resultado');
            const originalDisplay = resultadoElement.style.display;
            resultadoElement.style.display = 'block'; // Garante que o conte√∫do seja vis√≠vel para captura

            // Adicionar um t√≠tulo ao PDF
            doc.setFontSize(18);
            doc.text("Relat√≥rio de C√°lculo da Indeniza√ß√£o Financeira", 14, 22);

            // Usar html2canvas para renderizar o HTML com configura√ß√µes otimizadas
            const canvas = await html2canvas(resultadoElement, { 
                scale: 2,
                useCORS: true,
                logging: false,
                windowHeight: resultadoElement.scrollHeight
            });
            const imgData = canvas.toDataURL('image/png');
            
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            const pageHeight = doc.internal.pageSize.getHeight();
            
            let heightLeft = pdfHeight;
            let position = 30; // Posi√ß√£o inicial (ap√≥s o t√≠tulo)

            // Adicionar primeira p√°gina
            doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
            heightLeft -= (pageHeight - position);

            // Adicionar p√°ginas adicionais se necess√°rio
            while (heightLeft > 0) {
                position = heightLeft - pdfHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;
            }
            
            resultadoElement.style.display = originalDisplay; // Restaura o display original

            doc.save("relatorio_sma.pdf");
        }

        // Carregar a biblioteca jsPDF e html2canvas dinamicamente
        // Fun√ß√£o para validar contraproposta ao clicar no bot√£o
        function validarContraproposta() {
            const dados = {
                valor_regulagem: parseFloat(document.getElementById('valor_regulagem').value),
                valor_participacao: parseFloat(document.getElementById('valor_participacao').value),
                orcamento_oficina: parseFloat(document.getElementById('orcamento_oficina').value) || parseFloat(document.getElementById('valor_regulagem').value),
                dias_reparo: parseInt(document.getElementById('dias_reparo').value),
                dias_carro_reserva: parseInt(document.getElementById('dias_carro_reserva').value) || 0,
                contraproposta: parseFloat(document.getElementById('contraproposta_input').value) || 0,
                taxa_juros: parseFloat(document.getElementById('taxa_juros').value) / 100,
                n_parcelas: parseInt(document.getElementById('n_parcelas').value)
            };

            try {
                const result = calcularSMA(dados);
                exibirResultado(result);
            } catch (error) {
                console.error("Erro ao calcular com contraproposta:", error);
                alert("Ocorreu um erro ao tentar calcular com a contraproposta. Verifique os valores e tente novamente.");
            }
        }

        (function() {
            const scriptJsPDF = document.createElement('script');
            scriptJsPDF.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            document.head.appendChild(scriptJsPDF);

            const scriptHtml2Canvas = document.createElement('script');
            scriptHtml2Canvas.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            document.head.appendChild(scriptHtml2Canvas);
        })();

    </script>
</body>
</html>
